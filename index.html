<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Acrati | Puffs y Sofás a medida</title>
  <meta name="description" content="Puffs premium y tapizado a medida. Compra catálogo (pago 100%) o cotiza a medida (adelanto 50%). Comprobante desde la web." />
  <meta name="theme-color" content="#0f2a22" />

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Fraunces:opsz,wght@9..144,600;9..144,700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#fbf7f0;
      --ink:#101614;
      --muted:#5a625f;
      --muted2:#7c867f;
      --brand:#0f2a22;
      --gold:#b0893a;
      --border:rgba(16,22,20,.10);
      --shadow: 0 18px 52px rgba(16,22,20,.10);
      --shadow2: 0 10px 24px rgba(16,22,20,.08);
      --r-lg:26px;
      --r-md:18px;
      --r-sm:14px;
      --max:1180px;
      --focus:0 0 0 4px rgba(15,42,34,.18);
      --ease:cubic-bezier(.2,.8,.2,1);
      --font-body:"Inter", system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      --font-display:"Fraunces", ui-serif, Georgia, "Times New Roman", serif;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0; font-family:var(--font-body); color:var(--ink); line-height:1.55;
      background:
        radial-gradient(900px 560px at 18% 2%, rgba(15,42,34,.10), transparent 58%),
        radial-gradient(860px 540px at 82% 6%, rgba(176,137,58,.10), transparent 60%),
        var(--bg);
    }
    a{ color:inherit; text-decoration:none; }
    img{ max-width:100%; display:block; }
    .container{ max-width:var(--max); margin:0 auto; padding:0 18px; }

    /* Header */
    header{
      position:sticky; top:0; z-index:50;
      background: rgba(251,247,240,.86);
      border-bottom:1px solid rgba(16,22,20,.08);
      backdrop-filter: blur(10px);
    }
    .nav{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:12px 0;
    }
    .brand{ display:flex; align-items:center; gap:12px; }
    .mark{
      width:42px; height:42px; border-radius:16px;
      background: radial-gradient(circle at 30% 30%, rgba(176,137,58,.85), rgba(15,42,34,.92));
      border:1px solid rgba(16,22,20,.12);
      box-shadow: var(--shadow2);
    }
    .word{ display:flex; flex-direction:column; gap:2px; }
    .word .name{ font-family:var(--font-display); font-weight:700; letter-spacing:-.2px; font-size:22px; line-height:1; }
    .word .tag{ font-size:12px; color:var(--muted); font-weight:700; line-height:1; }

    nav ul{ list-style:none; display:flex; gap:16px; padding:0; margin:0; align-items:center; }
    nav a{ font-weight:800; font-size:13px; color:var(--muted); }
    nav a:hover{ color:var(--ink); }
    .nav-actions{ display:flex; gap:10px; align-items:center; }

    @media (max-width: 920px){
      nav ul{ display:none; }
    }

    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:10px;
      padding:12px 14px; border-radius:14px;
      border:1px solid rgba(16,22,20,.10);
      background: rgba(255,255,255,.80);
      color:var(--ink);
      font-weight:800; font-size:13px;
      cursor:pointer; user-select:none;
      transition: transform .18s var(--ease), box-shadow .18s var(--ease), background .18s var(--ease);
      box-shadow: 0 10px 22px rgba(16,22,20,.08);
      white-space:nowrap;
    }
    .btn:hover{ transform: translateY(-1px); box-shadow: var(--shadow); }
    .btn:focus{ outline:none; box-shadow: var(--shadow), var(--focus); }
    .btn.small{ padding:10px 12px; border-radius: 12px; font-size:12.5px; }
    .btn.primary{ background: linear-gradient(180deg, rgba(15,42,34,.98), rgba(15,42,34,.92)); color:#fff; border-color: rgba(15,42,34,.22); }
    .btn.secondary{ background: rgba(15,42,34,.08); color: var(--brand); border-color: rgba(15,42,34,.18); box-shadow: 0 10px 22px rgba(15,42,34,.08); }
    .btn.gold{ background: rgba(176,137,58,.12); border-color: rgba(176,137,58,.25); color: #6c5320; box-shadow: 0 10px 22px rgba(176,137,58,.10); }
    .btn.ghost{ background: transparent; box-shadow:none; }

    section{ padding: 26px 0; }
    .h1{
      font-family: var(--font-display);
      font-weight:700;
      letter-spacing:-.7px;
      font-size: clamp(30px, 3.2vw, 44px);
      line-height:1.05;
      margin: 0 0 10px;
    }
    .lead{ color:var(--muted); margin:0; font-size:15.5px; max-width: 74ch; }

    /* Probador */
    .hero{
      padding: 22px 0 10px;
    }
    .hero-grid{
      display:grid;
      grid-template-columns: 1.05fr .95fr;
      gap:14px;
      align-items:stretch;
    }
    @media (max-width: 980px){ .hero-grid{ grid-template-columns:1fr; } }

    .card{
      border:1px solid rgba(16,22,20,.10);
      background: rgba(255,255,255,.72);
      border-radius: var(--r-lg);
      box-shadow: var(--shadow2);
      overflow:hidden;
    }
    .pad{ padding: 16px; }

    .preview{
      position:relative;
      border-radius: var(--r-lg);
      overflow:hidden;
      border:1px solid rgba(16,22,20,.10);
      background: rgba(255,255,255,.88);
      box-shadow: var(--shadow);
      min-height: 360px;
    }
    .preview img{
      width:100%; height: 360px;
      object-fit: cover; object-position:center;
      filter: saturate(1.02) contrast(1.02);
      transform: scale(1.01);
    }
    /* “Tinte” para simular color final */
    .tint{
      position:absolute; inset:0;
      background: var(--tint, transparent);
      opacity: .22;
      mix-blend-mode: multiply;
      pointer-events:none;
    }
    .badge{
      position:absolute; top:14px; left:14px;
      background: rgba(255,255,255,.72);
      border:1px solid rgba(16,22,20,.10);
      border-radius: 999px;
      padding: 7px 10px;
      font-weight:900; font-size:12px; color:var(--muted);
      backdrop-filter: blur(8px);
      display:inline-flex; gap:8px; align-items:center;
    }
    .badge strong{ color:var(--brand); }
    .badge2{
      position:absolute; top:14px; right:14px;
      background: rgba(15,42,34,.92);
      border:1px solid rgba(15,42,34,.22);
      color:#fff;
      border-radius: 999px;
      padding: 7px 10px;
      font-weight:900; font-size:12px;
    }
    .info-row{
      display:flex; justify-content:space-between; align-items:flex-end; gap:10px; flex-wrap:wrap;
      margin-top: 12px;
    }
    .pricebox small{ color:var(--muted2); font-weight:900; font-size:11.5px; }
    .pricebox b{ display:block; font-size:18px; font-weight:900; letter-spacing:-.2px; }

    .controls{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top: 10px;
    }
    @media (max-width: 680px){ .controls{ grid-template-columns:1fr; } }

    label{ display:block; color:var(--muted); font-size:12.5px; font-weight:900; margin: 10px 0 6px; }
    input, select, textarea{
      width:100%;
      padding:12px 12px;
      border-radius: 14px;
      border:1px solid rgba(16,22,20,.12);
      background: rgba(255,255,255,.92);
      outline:none;
      font-family: var(--font-body);
      font-weight:650;
      font-size:13px;
      transition: box-shadow .16s var(--ease), border-color .16s var(--ease);
    }
    input:focus, select:focus, textarea:focus{ box-shadow: var(--focus); border-color: rgba(15,42,34,.22); }

    .swatches{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
      margin-top: 10px;
    }
    @media (max-width: 520px){ .swatches{ grid-template-columns: repeat(3, 1fr); } }

    .swatch{
      text-align:left;
      border:1px solid rgba(16,22,20,.10);
      background: rgba(255,255,255,.86);
      border-radius: 16px;
      padding: 10px;
      cursor:pointer;
      transition: transform .16s var(--ease), box-shadow .16s var(--ease), border-color .16s var(--ease);
      box-shadow: 0 10px 22px rgba(16,22,20,.08);
      user-select:none;
    }
    .swatch:hover{ transform: translateY(-1px); box-shadow: var(--shadow); }
    .swatch.active{ border-color: rgba(15,42,34,.28); outline: 2px solid rgba(15,42,34,.10); }
    .swrow{ display:flex; align-items:center; gap:10px; }
    .swdot{ width:22px; height:22px; border-radius:999px; background: var(--c, #ddd); border:1px solid rgba(0,0,0,.08); }
    .swname{ font-weight:900; font-size:12.8px; }
    .swmeta{ color:var(--muted2); font-weight:800; font-size:11.5px; margin-top:2px; }

    /* Catálogo limpio */
    .section-head{
      display:flex; justify-content:space-between; align-items:flex-end; gap:12px; flex-wrap:wrap;
      margin-bottom: 12px;
    }
    .section-head h2{ margin:0; font-size: 18px; font-weight:900; letter-spacing:-.2px; }
    .section-head p{ margin:6px 0 0; color:var(--muted); font-size:13.5px; max-width: 72ch; }

    .catalog{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
    }
    @media (max-width: 980px){ .catalog{ grid-template-columns:1fr; } }

    .p-card{
      border:1px solid rgba(16,22,20,.10);
      background: rgba(255,255,255,.74);
      border-radius: var(--r-lg);
      box-shadow: var(--shadow2);
      overflow:hidden;
      transition: transform .18s var(--ease), box-shadow .18s var(--ease);
      cursor:pointer;
    }
    .p-card:hover{ transform: translateY(-2px); box-shadow: var(--shadow); }
    .p-media{ aspect-ratio: 4/3; background:#fff; border-bottom: 1px solid rgba(16,22,20,.08); overflow:hidden; }
    .p-media img{ width:100%; height:100%; object-fit:cover; }
    .p-body{ padding: 14px; }
    .p-title{ display:flex; justify-content:space-between; gap:10px; align-items:flex-start; }
    .p-body h3{ margin:0; font-size: 15px; font-weight:900; }
    .p-body p{ margin:6px 0 0; color:var(--muted); font-size: 13.5px; }
    .pill{
      font-size: 12px; font-weight:900; color: var(--muted);
      border:1px solid rgba(16,22,20,.10);
      background: rgba(255,255,255,.70);
      padding: 6px 10px;
      border-radius: 999px;
      white-space:nowrap;
    }
    .p-foot{
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid rgba(16,22,20,.08);
      display:flex; justify-content:space-between; align-items:center; gap:10px;
    }
    .mini{ color:var(--muted); font-size:12.5px; margin-top:8px; }

    /* Carrito flotante minimal */
    .cartbar{
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: 14px;
      z-index: 70;
      width: min(920px, calc(100% - 28px));
      display:none;
    }
    .cartbar .inner{
      border:1px solid rgba(16,22,20,.12);
      background: rgba(255,255,255,.92);
      border-radius: 999px;
      box-shadow: 0 20px 55px rgba(16,22,20,.16);
      padding: 10px 10px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      backdrop-filter: blur(10px);
    }
    .cartbar .left{ display:flex; flex-direction:column; gap:2px; padding-left: 8px; }
    .cartbar .left b{ font-size: 12.8px; font-weight: 900; }
    .cartbar .left span{ font-size: 12px; color:var(--muted); font-weight: 800; }
    .cartbar .actions{ display:flex; gap:8px; align-items:center; }

    /* Modales */
    .modal{
      position: fixed; inset:0;
      background: rgba(16,22,20,.52);
      display:none;
      z-index: 120;
      padding: 18px;
    }
    .modal.open{ display:flex; align-items:flex-start; justify-content:center; }
    .sheet{
      width: min(980px, 100%);
      margin: 24px auto 0;
      border-radius: 22px;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.94);
      box-shadow: 0 30px 90px rgba(16,22,20,.22);
      overflow:hidden;
      transform: translateY(6px);
      animation: pop .16s var(--ease) both;
    }
    @keyframes pop{ from{ opacity:0; transform: translateY(14px);} to{opacity:1; transform: translateY(0);} }
    .sheet-head{
      display:flex; justify-content:space-between; align-items:flex-start; gap:10px;
      padding: 14px;
      border-bottom: 1px solid rgba(16,22,20,.08);
      background: rgba(251,247,240,.72);
    }
    .sheet-head .t{ display:flex; flex-direction:column; gap:4px; }
    .sheet-head .t b{ font-size: 14px; font-weight:900; }
    .sheet-head .t span{ color:var(--muted); font-size:12.5px; }
    .sheet-body{ padding: 14px; }

    .panel{
      border:1px solid rgba(16,22,20,.10);
      background: rgba(255,255,255,.74);
      border-radius: var(--r-lg);
      box-shadow: var(--shadow2);
      padding: 14px;
    }
    .notice{
      margin-top: 10px;
      padding: 12px 14px;
      border-radius: 16px;
      border: 1px solid rgba(15,42,34,.16);
      background: rgba(15,42,34,.08);
      color: #103329;
      font-weight: 800;
      font-size: 12.8px;
    }
    .warn{
      border-color: rgba(176,137,58,.22);
      background: rgba(176,137,58,.10);
      color: #5b441a;
    }

    footer{
      border-top:1px solid rgba(16,22,20,.08);
      padding: 18px 0 90px; /* espacio para cartbar */
      color:var(--muted);
      font-size: 13px;
    }
    .footrow{ display:flex; justify-content:space-between; gap:12px; flex-wrap:wrap; }

    /* Toasts */
    .toasts{
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: 84px;
      z-index: 160;
      width: min(560px, calc(100% - 28px));
      display:flex;
      flex-direction:column;
      gap:10px;
      pointer-events:none;
    }
    .toast{
      pointer-events:auto;
      border:1px solid rgba(16,22,20,.12);
      background: rgba(255,255,255,.92);
      border-radius: 16px;
      box-shadow: var(--shadow);
      padding: 12px 14px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:flex-start;
      animation: pop .16s var(--ease) both;
    }
    .toast b{ font-weight: 900; }
    .toast p{ margin:4px 0 0; color:var(--muted); font-size: 12.8px; font-weight: 750; }
  </style>
</head>

<body>
<header>
  <div class="container nav">
    <a class="brand" href="#top" aria-label="Acrati">
      <span class="mark" aria-hidden="true"></span>
      <span class="word">
        <span class="name">Acrati</span>
        <span class="tag">Puffs premium + Tapizado a medida</span>
      </span>
    </a>

    <nav aria-label="Navegación principal">
      <ul>
        <li><a href="#catalogo">Catálogo</a></li>
        <li><a href="#amedida">A medida</a></li>
        <li><a href="#faq">FAQ</a></li>
      </ul>
    </nav>

    <div class="nav-actions">
      <button class="btn secondary" id="btnCart" type="button">Carrito</button>
      <a class="btn primary" id="btnWA" href="#" rel="noopener">WhatsApp</a>
    </div>
  </div>
</header>

<div class="toasts" id="toasts" aria-live="polite" aria-atomic="true"></div>

<main id="top" class="container">
  <!-- FRANJA 1: PROBADOR -->
  <section class="hero">
    <div class="hero-grid">
      <div class="card">
        <div class="pad">
          <h1 class="h1">Prueba el diseño, elige el color y agrégalo al carrito.</h1>
          <p class="lead">
            Catálogo: pago <b>100%</b>. A medida: cotización y adelanto <b>50%</b>.
            Todo queda ordenado con ID de pedido + comprobante.
          </p>

          <div class="info-row" style="margin-top:14px">
            <div>
              <div class="mini" id="probeSummary">—</div>
            </div>
            <div class="pricebox" style="text-align:right">
              <small>Total estimado</small>
              <b id="probeTotal">—</b>
            </div>
          </div>

          <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:12px">
            <button class="btn primary" id="btnAddFromProbe" type="button">Agregar al carrito</button>
            <button class="btn gold" id="btnQuote" type="button">Cotizar a medida</button>
          </div>

          <div class="notice" style="margin-top:12px">
            Si te gusta el resultado del “probador”, tu compra queda lista en 2 pasos: Carrito → Pagar → Subir comprobante.
          </div>
        </div>
      </div>

      <div class="card">
        <div class="pad">
          <div class="preview" id="preview" style="--tint: transparent;">
            <div class="badge"><strong id="badgeModel">—</strong> • <span id="badgeFabric">—</span></div>
            <div class="badge2" id="badgeLegs">Patas: —</div>

            <img id="previewImg" src="rosseta.png" alt="Vista previa del producto"
                 onerror="this.style.display='none'; this.parentElement.style.minHeight='220px'; this.parentElement.insertAdjacentHTML('beforeend','<div style=&quot;padding:16px;font-weight:900&quot;>Sube la imagen del producto (ej: <code>rosseta.png</code>) junto al <code>index.html</code>.</div>');">
            <div class="tint" id="previewTint"></div>
          </div>

          <div class="controls">
            <div>
              <label>Modelo (catálogo)</label>
              <select id="probeProduct"></select>
            </div>
            <div>
              <label>Cantidad</label>
              <input id="probeQty" type="number" min="1" value="1"/>
            </div>

            <div>
              <label>Tipo de tela</label>
              <select id="probeFabric"></select>
            </div>
            <div>
              <label>Patas</label>
              <select id="probeLegs">
                <option value="Negro" selected>Negro</option>
                <option value="Dorado">Dorado</option>
                <option value="Plateado">Plateado</option>
              </select>
            </div>
          </div>

          <label style="margin-top:12px">Color</label>
          <div class="swatches" id="probeSwatches"></div>

          <div class="mini">
            Vista previa: imagen + tinte del color elegido (simulación). En producción se confirma la tela real.
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- CATALOGO (LIMPIO) -->
  <section id="catalogo">
    <div class="section-head">
      <div>
        <h2>Catálogo</h2>
        <p>Haz clic en un producto para cargarlo en el “probador” de arriba y agregarlo al carrito.</p>
      </div>
      <button class="btn secondary" type="button" id="btnScrollTop">Ir al probador</button>
    </div>

    <div class="catalog" id="catalogGrid"></div>
  </section>

  <!-- A MEDIDA (MINIMO) -->
  <section id="amedida">
    <div class="section-head">
      <div>
        <h2>A medida / por referencia</h2>
        <p>Envíanos foto o link (Pinterest/IG). Cotizamos y agendamos con adelanto 50%.</p>
      </div>
    </div>

    <div class="card">
      <div class="pad">
        <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between">
          <div>
            <div style="font-weight:900">¿Tienes una referencia?</div>
            <div class="mini">Foto/link + medidas + ciudad. Listo.</div>
          </div>
          <div style="display:flex; gap:10px; flex-wrap:wrap">
            <button class="btn gold" id="btnQuote2" type="button">Cotizar a medida</button>
            <a class="btn secondary" id="btnWA2" href="#" rel="noopener">WhatsApp</a>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- FAQ (BREVE) -->
  <section id="faq">
    <div class="section-head">
      <div>
        <h2>FAQ</h2>
        <p>Respuestas cortas para cerrar ventas sin fricción.</p>
      </div>
    </div>

    <div class="catalog" style="grid-template-columns: repeat(2, 1fr);">
      <div class="panel">
        <div style="font-weight:900">¿Cómo pago?</div>
        <div class="mini">Yape/Plin/Transferencia. Catálogo paga 100%. Luego subes el comprobante desde la web.</div>
      </div>
      <div class="panel">
        <div style="font-weight:900">¿A medida?</div>
        <div class="mini">Primero cotizamos. Luego adelanto 50% para iniciar producción y saldo antes del envío.</div>
      </div>
      <div class="panel">
        <div style="font-weight:900">¿Envíos?</div>
        <div class="mini">Lima coordinado. Provincias por Shalom con guía y embalaje protegido.</div>
      </div>
      <div class="panel">
        <div style="font-weight:900">¿Tiempo?</div>
        <div class="mini">Depende del modelo/tela y cola. Se confirma al validar el pago/adelanto.</div>
      </div>
    </div>
  </section>
</main>

<footer>
  <div class="container footrow">
    <div>© <span id="year"></span> Acrati.</div>
    <div style="display:flex; gap:12px; flex-wrap:wrap">
      <a href="#catalogo">Catálogo</a>
      <a href="#amedida">A medida</a>
      <a href="#faq">FAQ</a>
    </div>
  </div>
</footer>

<!-- Cartbar -->
<div class="cartbar" id="cartBar">
  <div class="inner">
    <div class="left">
      <b id="cartBarTitle">Tu pedido</b>
      <span id="cartBarSub">0 ítems</span>
    </div>
    <div class="actions">
      <button class="btn ghost small" id="btnClearCart" type="button">Vaciar</button>
      <button class="btn secondary small" id="btnOpenCart" type="button">Ver</button>
      <button class="btn primary small" id="btnCheckout" type="button">Pagar</button>
    </div>
  </div>
</div>

<!-- MODAL: Cart -->
<div class="modal" id="cartModal" aria-hidden="true">
  <div class="sheet">
    <div class="sheet-head">
      <div class="t">
        <b>Carrito</b>
        <span>Catálogo: pago 100%. El comprobante se sube en el paso de pago.</span>
      </div>
      <button class="btn ghost" id="btnCloseCart" type="button">Cerrar</button>
    </div>
    <div class="sheet-body">
      <div class="panel">
        <div id="cartList" style="display:flex; flex-direction:column; gap:10px;"></div>
        <div class="notice" style="margin-top:12px">
          Total: <b id="cartTotal">S/ 0</b>
        </div>
        <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:12px">
          <button class="btn secondary" id="btnBackToProbe" type="button">Seguir probando</button>
          <button class="btn primary" id="btnGoPay" type="button">Continuar a pago</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- MODAL: Pay + Upload proof -->
<div class="modal" id="payModal" aria-hidden="true">
  <div class="sheet" style="max-width:920px">
    <div class="sheet-head">
      <div class="t">
        <b>Pago y comprobante</b>
        <span>Se genera un ID y el comprobante se guarda en Drive + se enlaza en Sheets.</span>
      </div>
      <button class="btn ghost" id="btnClosePay" type="button">Cerrar</button>
    </div>
    <div class="sheet-body">
      <div class="catalog" style="grid-template-columns: 1fr 1fr;">
        <div class="panel">
          <div style="font-weight:900">1) Datos del cliente</div>

          <label>Nombre</label>
          <input id="coName" placeholder="Ej: María"/>

          <label>WhatsApp</label>
          <input id="coPhone" placeholder="Ej: 955510450"/>

          <label>Ciudad</label>
          <input id="coCity" placeholder="Ej: Lima"/>

          <label>Dirección / referencia (opcional)</label>
          <input id="coAddress" placeholder="Distrito, referencia..."/>

          <div class="notice warn">
            Catálogo requiere pago <b>100%</b> antes de producción.
          </div>
        </div>

        <div class="panel">
          <div style="font-weight:900">2) Pagar + subir comprobante</div>
          <div class="mini" id="payInfo" style="margin-top:6px">—</div>

          <div class="notice" style="margin-top:10px">
            Yape / WhatsApp: <b id="payNumber">955510450</b>
          </div>

          <label>Comprobante (foto o PDF)</label>
          <input id="pmFile" type="file" accept="image/*,application/pdf"/>

          <label>N° operación (opcional)</label>
          <input id="pmOp" placeholder="Ej: 123456"/>

          <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:12px">
            <button class="btn primary" id="btnPlaceOrderAndUpload" type="button">Registrar pedido + subir comprobante</button>
            <a class="btn secondary" id="btnPayWA" href="#" rel="noopener">WhatsApp</a>
          </div>

          <div class="mini" id="payHint" style="margin-top:10px"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- MODAL: Quote (minimal) -->
<div class="modal" id="quoteModal" aria-hidden="true">
  <div class="sheet" style="max-width:860px">
    <div class="sheet-head">
      <div class="t">
        <b>Cotizar a medida / retapizado</b>
        <span>Se registra en Sheets para seguimiento.</span>
      </div>
      <button class="btn ghost" id="btnCloseQuote" type="button">Cerrar</button>
    </div>
    <div class="sheet-body">
      <div class="panel">
        <div class="controls" style="grid-template-columns: 1fr 1fr;">
          <div>
            <label>Nombre</label>
            <input id="qName" placeholder="Nombre"/>
          </div>
          <div>
            <label>WhatsApp</label>
            <input id="qPhone" placeholder="955510450"/>
          </div>
          <div>
            <label>Ciudad</label>
            <input id="qCity" placeholder="Lima / Provincia"/>
          </div>
          <div>
            <label>Link de referencia (Pinterest/IG)</label>
            <input id="qRef" placeholder="Pega link"/>
          </div>
        </div>

        <label>Detalles (medidas, tela, uso, fecha)</label>
        <textarea id="qDetails" placeholder="Medidas aprox., tela/color, uso (hogar/negocio), fecha deseada..."></textarea>

        <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:12px">
          <button class="btn primary" id="btnSaveQuote" type="button">Guardar solicitud</button>
          <a class="btn secondary" id="btnQuoteWA" href="#" rel="noopener">WhatsApp</a>
        </div>

        <div class="notice warn">
          Para iniciar producción: adelanto 50% (una vez confirmada la cotización).
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // =========================
  // CONFIG
  // =========================
  const BRAND_NAME = "Acrati";
  const WHATSAPP_NUMBER = "51955510450"; // 51 + 955510450
  const YAPE_NUMBER = "955510450";

  const SHEETS_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbxykQZyRzldx10RUdT6v2TqgFNq8YhpHSVz24KMv_N40-uAKrBmCsMwSAqZ1PBMxPMp/exec";

  // Catálogo (ajusta tus productos e imágenes)
  const PRODUCTS = [
    { id:"rosseta", name:"Puff Rosseta", price:430, img:"rosseta.png", desc:"Cómodo y elegante. Ideal para sala/dormitorio.", category:"puffs" },
    { id:"nido", name:"Puff Nido", price:399, img:"nido.png", desc:"Minimal y versátil.", category:"puffs" },
    { id:"sofa_mod", name:"Sofá modular", price:0, img:"sofa.png", desc:"A medida por módulos (cotización).", category:"sofas" }
  ];

  const FABRICS = [
    { type:"Chenille premium", note:"Suave y resistente", swatches:[
      { name:"Oliva", color:"#5b6a40" }, { name:"Arena", color:"#d7c6ac" }, { name:"Grafito", color:"#444444" }, { name:"Hueso", color:"#f2eee7" }
    ]},
    { type:"Antimanchas", note:"Fácil limpieza", swatches:[
      { name:"Petróleo", color:"#1f4c57" }, { name:"Café", color:"#6b4e35" }, { name:"Gris", color:"#cfcfcf" }, { name:"Oliva oscuro", color:"#3f4a2a" }
    ]}
  ];

  // =========================
  // Helpers
  // =========================
  const $ = (id)=>document.getElementById(id);
  const waLink = (text)=>`https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(text)}`;
  const fmtPEN = (n)=> (Number(n)>0 ? `S/ ${Number(n).toFixed(0)}` : "Consultar");

  const toast = (title, msg="")=>{
    const wrap = $("toasts");
    const el = document.createElement("div");
    el.className = "toast";
    el.innerHTML = `<div><b>${title}</b>${msg?`<p>${msg}</p>`:""}</div><button class="btn ghost small" type="button">Cerrar</button>`;
    el.querySelector("button").addEventListener("click", ()=>el.remove());
    wrap.appendChild(el);
    setTimeout(()=>{ if (el.parentElement) el.remove(); }, 3400);
  };

  const openModal = (m)=>{ m.classList.add("open"); m.setAttribute("aria-hidden","false"); };
  const closeModal = (m)=>{ m.classList.remove("open"); m.setAttribute("aria-hidden","true"); };

  const nowISO = ()=> new Date().toISOString();
  const genOrderId = ()=>{
    const d=new Date();
    const yyyy=d.getFullYear();
    const mm=String(d.getMonth()+1).padStart(2,"0");
    const dd=String(d.getDate()).padStart(2,"0");
    const rand=Math.floor(Math.random()*9000)+1000;
    return `ACR-${yyyy}${mm}${dd}-${rand}`;
  };

  const postToSheets = async(payload)=>{
    try{
      await fetch(SHEETS_WEBAPP_URL,{
        method:"POST", mode:"no-cors",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(payload)
      });
      return {ok:true};
    }catch(e){
      return {ok:false, error:String(e)};
    }
  };

  const fileToBase64 = (file)=> new Promise((resolve,reject)=>{
    const r=new FileReader();
    r.onload=()=>{
      const dataUrl=String(r.result||"");
      const idx=dataUrl.indexOf("base64,");
      if(idx===-1) return reject(new Error("No se pudo leer el archivo."));
      resolve({ mime:file.type||"application/octet-stream", name:file.name||"comprobante", b64:dataUrl.slice(idx+7) });
    };
    r.onerror=()=>reject(new Error("Error leyendo archivo"));
    r.readAsDataURL(file);
  });

  // =========================
  // WhatsApp buttons + year
  // =========================
  $("btnWA").href = waLink(`Hola, quiero información sobre ${BRAND_NAME}.`);
  $("btnWA2").href = $("btnWA").href;
  $("btnPayWA").href = $("btnWA").href;
  $("year").textContent = new Date().getFullYear();
  $("payNumber").textContent = YAPE_NUMBER;

  // =========================
  // PROBADOR STATE
  // =========================
  const state = {
    productId: PRODUCTS[0]?.id || "",
    qty: 1,
    fabricType: FABRICS[0]?.type || "",
    swatchName: FABRICS[0]?.swatches?.[0]?.name || "",
    swatchColor: FABRICS[0]?.swatches?.[0]?.color || "#000000",
    legs: "Negro",
  };

  const setPreviewTint = (hex)=>{
    $("preview").style.setProperty("--tint", hex || "transparent");
    // actual tint layer uses CSS variable by inheriting background
    $("previewTint").style.background = hex || "transparent";
  };

  const renderProbeProducts = ()=>{
    const sel = $("probeProduct");
    sel.innerHTML = "";
    PRODUCTS.filter(p => Number(p.price)>0).forEach(p=>{
      const opt=document.createElement("option");
      opt.value=p.id;
      opt.textContent=`${p.name} (${fmtPEN(p.price)})`;
      sel.appendChild(opt);
    });
    // Si el primero no tiene precio, cae al primero con precio
    if (!PRODUCTS.find(p=>p.id===state.productId && p.price>0)){
      state.productId = PRODUCTS.find(p=>p.price>0)?.id || "";
    }
    sel.value = state.productId;
  };

  const renderProbeFabrics = ()=>{
    const sel = $("probeFabric");
    sel.innerHTML = "";
    FABRICS.forEach(f=>{
      const opt=document.createElement("option");
      opt.value=f.type;
      opt.textContent=`${f.type} — ${f.note}`;
      sel.appendChild(opt);
    });
    sel.value = state.fabricType;
  };

  const renderSwatches = ()=>{
    const group = FABRICS.find(f=>f.type===state.fabricType) || FABRICS[0];
    const wrap = $("probeSwatches");
    wrap.innerHTML = "";
    const sw = group.swatches || [];
    if (!sw.length) return;

    // Si el swatch actual no existe en el grupo, setea el primero
    if (!sw.some(x=>x.name===state.swatchName)){
      state.swatchName = sw[0].name;
      state.swatchColor = sw[0].color;
    }

    sw.forEach(s=>{
      const b=document.createElement("button");
      b.type="button";
      b.className="swatch";
      b.style.setProperty("--c", s.color);
      b.innerHTML = `
        <div class="swrow">
          <div class="swdot"></div>
          <div>
            <div class="swname">${s.name}</div>
            <div class="swmeta">${group.type}</div>
          </div>
        </div>`;
      b.addEventListener("click", ()=>{
        [...wrap.querySelectorAll(".swatch")].forEach(x=>x.classList.remove("active"));
        b.classList.add("active");
        state.swatchName=s.name;
        state.swatchColor=s.color;
        setPreviewTint(state.swatchColor);
        syncProbeUI();
      });
      if (s.name===state.swatchName) b.classList.add("active");
      wrap.appendChild(b);
    });

    setPreviewTint(state.swatchColor);
  };

  const syncProbeUI = ()=>{
    const p = PRODUCTS.find(x=>x.id===state.productId);
    if (!p) return;

    $("badgeModel").textContent = p.name;
    $("badgeFabric").textContent = state.swatchName;
    $("badgeLegs").textContent = `Patas: ${state.legs}`;

    const img = $("previewImg");
    img.src = p.img || "rosseta.png";

    const total = Number(p.price || 0) * Number(state.qty || 1);
    $("probeTotal").textContent = fmtPEN(total);

    $("probeSummary").textContent =
      `${p.name} • ${state.fabricType} • ${state.swatchName} • Patas ${state.legs} • x${state.qty}`;

    // WhatsApp context
    $("btnWA").href = waLink(
      `Hola, quiero información sobre ${BRAND_NAME}.\n` +
      `Me interesa: ${p.name}\n` +
      `Tela: ${state.fabricType}\nColor: ${state.swatchName}\nPatas: ${state.legs}\nCantidad: ${state.qty}`
    );
    $("btnWA2").href = $("btnWA").href;
    $("btnPayWA").href = $("btnWA").href;
  };

  // Wire probe inputs
  $("probeProduct").addEventListener("change",(e)=>{
    state.productId = e.target.value;
    syncProbeUI();
  });
  $("probeQty").addEventListener("input",(e)=>{
    state.qty = Math.max(1, Number(e.target.value || 1));
    syncProbeUI();
  });
  $("probeFabric").addEventListener("change",(e)=>{
    state.fabricType = e.target.value;
    renderSwatches();
    syncProbeUI();
  });
  $("probeLegs").addEventListener("change",(e)=>{
    state.legs = e.target.value;
    syncProbeUI();
  });

  // =========================
  // Catalog (click loads into probe)
  // =========================
  const renderCatalog = ()=>{
    const grid = $("catalogGrid");
    grid.innerHTML = "";
    const items = PRODUCTS.filter(p => Number(p.price)>0);

    items.forEach(p=>{
      const el=document.createElement("div");
      el.className="p-card";
      el.innerHTML = `
        <div class="p-media">
          <img src="${p.img}" alt="${p.name}" onerror="this.style.display='none'">
        </div>
        <div class="p-body">
          <div class="p-title">
            <h3>${p.name}</h3>
            <span class="pill">${fmtPEN(p.price)}</span>
          </div>
          <p>${p.desc || ""}</p>
          <div class="p-foot">
            <span class="mini">Clic para probar arriba</span>
            <button class="btn small secondary" type="button">Probar</button>
          </div>
        </div>
      `;
      el.addEventListener("click", ()=>{
        state.productId = p.id;
        $("probeProduct").value = p.id;
        syncProbeUI();
        window.scrollTo({ top: 0, behavior: "smooth" });
      });
      grid.appendChild(el);
    });
  };

  $("btnScrollTop").addEventListener("click", ()=> window.scrollTo({ top:0, behavior:"smooth" }));

  // =========================
  // Cart
  // =========================
  const CART_KEY="acrati_cart_clean_v1";
  const getCart=()=>{ try{return JSON.parse(localStorage.getItem(CART_KEY)||"[]");}catch{return [];} };
  const setCart=(x)=>localStorage.setItem(CART_KEY, JSON.stringify(x));
  const cartTotal=(c)=>c.reduce((s,it)=>s+(Number(it.unit_price||0)*Number(it.qty||1)),0);

  const refreshCartBar=()=>{
    const c=getCart();
    if(!c.length){ $("cartBar").style.display="none"; return; }
    $("cartBar").style.display="block";
    $("cartBarTitle").textContent = `Tu pedido (${c.length} ítem${c.length>1?"s":""})`;
    $("cartBarSub").textContent = `${c.reduce((a,b)=>a+(Number(b.qty)||1),0)} unidad(es) • ${fmtPEN(cartTotal(c))}`;
  };

  const addFromProbe=()=>{
    const p=PRODUCTS.find(x=>x.id===state.productId);
    if(!p || Number(p.price)<=0){
      toast("Este producto es por cotización", "Usa “Cotizar a medida”.");
      return;
    }
    const item = {
      line_id: "L-"+Math.random().toString(36).slice(2,8).toUpperCase()+"-"+Date.now().toString(36).toUpperCase(),
      product_id: p.id,
      product_name: p.name,
      unit_price: Number(p.price||0),
      qty: Math.max(1, Number(state.qty||1)),
      fabric_type: state.fabricType,
      swatch_name: state.swatchName,
      swatch_color: state.swatchColor,
      legs: state.legs
    };
    const c=getCart();
    c.unshift(item);
    setCart(c);
    refreshCartBar();
    toast("Agregado al carrito", `${p.name} • ${state.swatchName} • x${item.qty}`);
  };

  $("btnAddFromProbe").addEventListener("click", addFromProbe);

  // Cart modal
  const cartModal=$("cartModal");
  const payModal=$("payModal");
  const quoteModal=$("quoteModal");

  const renderCartModal=()=>{
    const c=getCart();
    const list=$("cartList");
    list.innerHTML = "";
    if(!c.length){
      list.innerHTML = `<div class="notice warn">Tu carrito está vacío.</div>`;
      $("cartTotal").textContent = "S/ 0";
      return;
    }
    c.forEach(it=>{
      const row=document.createElement("div");
      row.className="panel";
      row.style.boxShadow="none";
      row.innerHTML=`
        <div style="display:flex; justify-content:space-between; gap:10px; align-items:flex-start;">
          <div>
            <div style="font-weight:900">${it.product_name}</div>
            <div class="mini" style="margin-top:4px">${it.fabric_type} • ${it.swatch_name} • Patas ${it.legs} • x${it.qty}</div>
          </div>
          <div style="display:flex; flex-direction:column; gap:8px; align-items:flex-end;">
            <div style="font-weight:900">${fmtPEN(it.unit_price*it.qty)}</div>
            <button class="btn ghost small" type="button">Quitar</button>
          </div>
        </div>
      `;
      row.querySelector("button").addEventListener("click", ()=>{
        const next=getCart().filter(x=>x.line_id!==it.line_id);
        setCart(next);
        refreshCartBar();
        renderCartModal();
      });
      list.appendChild(row);
    });
    $("cartTotal").textContent = fmtPEN(cartTotal(c));
  };

  const openCart=()=>{
    renderCartModal();
    openModal(cartModal);
  };

  $("btnCart").addEventListener("click", openCart);
  $("btnOpenCart").addEventListener("click", openCart);
  $("btnCheckout").addEventListener("click", ()=>{
    openCart();
  });

  $("btnCloseCart").addEventListener("click", ()=>closeModal(cartModal));
  cartModal.addEventListener("click",(e)=>{ if(e.target===cartModal) closeModal(cartModal); });

  $("btnClearCart").addEventListener("click", ()=>{
    setCart([]);
    refreshCartBar();
    toast("Carrito vacío");
  });

  $("btnBackToProbe").addEventListener("click", ()=>{
    closeModal(cartModal);
    window.scrollTo({ top:0, behavior:"smooth" });
  });

  $("btnGoPay").addEventListener("click", ()=>{
    closeModal(cartModal);
    openPay();
  });

  // =========================
  // PAY FLOW: Registrar pedido + subir comprobante (en un solo paso)
  // =========================
  let lastOrderId = "";

  const openPay=()=>{
    const c=getCart();
    if(!c.length){
      toast("Carrito vacío", "Agrega un producto en el probador.");
      return;
    }
    const total = cartTotal(c);
    $("payInfo").innerHTML =
      `<div><b>Total a pagar (catálogo 100%):</b> ${fmtPEN(total)}</div>`+
      `<div style="margin-top:6px;color:#5a625f;font-weight:800">Luego sube tu comprobante aquí mismo.</div>`;
    openModal(payModal);
  };

  $("btnClosePay").addEventListener("click", ()=>closeModal(payModal));
  payModal.addEventListener("click",(e)=>{ if(e.target===payModal) closeModal(payModal); });

  const buildOrderPayload=()=>{
    const c=getCart();
    const total=cartTotal(c);
    const orderId = genOrderId();
    lastOrderId = orderId;

    return {
      ts: nowISO(),
      event: "order_checkout",
      order_id: orderId,
      order_type: "CATALOGO",
      payment_policy: "CATALOGO_100",
      pay_stage_due_now: "TOTAL",
      amount_due_now: total,
      amount_total: total,
      customer_name: $("coName").value.trim(),
      customer_phone: $("coPhone").value.trim(),
      customer_city: $("coCity").value.trim(),
      customer_address: $("coAddress").value.trim(),
      pay_method: "Yape",
      pay_status: "Comprobante pendiente",
      items: c,
      items_summary: c.map(it=>`${it.product_name} x${it.qty} (${it.fabric_type}/${it.swatch_name}/Patas:${it.legs})`).join(" || "),
      page: location.href
    };
  };

  $("btnPlaceOrderAndUpload").addEventListener("click", async ()=>{
    const c=getCart();
    if(!c.length){ toast("Carrito vacío"); return; }

    const name = $("coName").value.trim();
    const phone = $("coPhone").value.trim();
    if(!name || !phone){
      toast("Completa tus datos", "Nombre y WhatsApp son necesarios.");
      return;
    }

    const file = $("pmFile").files && $("pmFile").files[0] ? $("pmFile").files[0] : null;
    if(!file){
      toast("Falta comprobante", "Adjunta una foto o PDF del pago.");
      return;
    }
    const maxBytes = 2 * 1024 * 1024;
    if(file.size > maxBytes){
      toast("Archivo muy pesado", "Recomendado: <= 2MB.");
      return;
    }

    $("payHint").textContent = "Registrando pedido y subiendo comprobante...";

    // 1) Create order in Sheets
    const order = buildOrderPayload();
    await postToSheets(order);

    // 2) Upload proof
    const total = order.amount_total;
    const f = await fileToBase64(file);

    const proof = {
      ts: nowISO(),
      action: "payment_upload",
      order_id: order.order_id,
      stage: "TOTAL",
      amount: Number(total),
      pay_method: "Yape",
      operation_number: $("pmOp").value.trim(),
      file_name: f.name,
      file_mime: f.mime,
      file_b64: f.b64,
      page: location.href
    };
    await postToSheets(proof);

    // Cleanup UI
    setCart([]);
    refreshCartBar();
    $("pmFile").value = "";
    $("pmOp").value = "";
    $("payHint").textContent = `Listo. Tu pedido quedó registrado con ID: ${order.order_id}. Validaremos el pago.`;

    toast("Pedido registrado", `ID: ${order.order_id}`);

    // WhatsApp contextual
    const msg =
      `Hola, ya registré mi pedido (${BRAND_NAME}).\n`+
      `ID: ${order.order_id}\n`+
      `Total: ${fmtPEN(order.amount_total)}\n`+
      `Yape: ${YAPE_NUMBER}\n`+
      `Nombre: ${order.customer_name}\n`+
      `WhatsApp: ${order.customer_phone}\n`+
      `Gracias.`;
    $("btnPayWA").href = waLink(msg);
  });

  // =========================
  // Quote minimal
  // =========================
  const openQuote=()=>openModal(quoteModal);
  $("btnQuote").addEventListener("click", openQuote);
  $("btnQuote2").addEventListener("click", openQuote);
  $("btnCloseQuote").addEventListener("click", ()=>closeModal(quoteModal));
  quoteModal.addEventListener("click",(e)=>{ if(e.target===quoteModal) closeModal(quoteModal); });

  $("btnQuoteWA").addEventListener("click", ()=>{
    const msg =
      `Hola, quiero cotizar a medida (${BRAND_NAME}).\n`+
      `Nombre: ${$("qName").value.trim() || "—"}\n`+
      `WhatsApp: ${$("qPhone").value.trim() || "—"}\n`+
      `Ciudad: ${$("qCity").value.trim() || "—"}\n`+
      `Referencia: ${$("qRef").value.trim() || "—"}\n`+
      `Detalles: ${$("qDetails").value.trim() || "—"}`;
    $("btnQuoteWA").href = waLink(msg);
  });

  $("btnSaveQuote").addEventListener("click", async ()=>{
    const payload = {
      ts: nowISO(),
      event: "lead_quote",
      lead_id: "LEAD-" + Date.now().toString(36).toUpperCase(),
      service: "Pedido a medida / retapizado",
      customer_name: $("qName").value.trim(),
      customer_phone: $("qPhone").value.trim(),
      customer_city: $("qCity").value.trim(),
      reference_link: $("qRef").value.trim(),
      details: $("qDetails").value.trim(),
      page: location.href
    };
    await postToSheets(payload);
    toast("Solicitud registrada", "Te contactaremos para cotizar.");
    closeModal(quoteModal);
  });

  // ESC to close
  document.addEventListener("keydown",(e)=>{
    if(e.key!=="Escape") return;
    [cartModal,payModal,quoteModal].forEach(m=>{ if(m.classList.contains("open")) closeModal(m); });
  });

  // Init
  renderProbeProducts();
  renderProbeFabrics();
  $("probeQty").value = state.qty;
  $("probeProduct").value = state.productId;
  $("probeFabric").value = state.fabricType;
  renderSwatches();
  syncProbeUI();
  renderCatalog();
  refreshCartBar();
</script>
</body>
</html>
